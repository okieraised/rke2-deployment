replicas: 1
ports:
  - name: http
    containerPort: 80
service:
  enabled: true
  type: ClusterIP
  ports:
    - name: http
      port: 80
      targetPort: http
    - name: https
      port: 443
      protocol: TCP
      targetPort: http
configmaps:
  - name: gateway-nginx
    valuesMultiLine:
      default.conf: |-
        user  nginx;
        worker_processes  auto;
        
        error_log  /var/log/nginx/error.log notice;
        pid        /run/nginx.pid;
        
        
        events {
          worker_connections  1024;
        }
        
        stream {
            include /etc/nginx/stream.d/*.conf;
        }
        
        http {
          include       /etc/nginx/mime.types;
          default_type  application/octet-stream;
        
          log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
          '$status $body_bytes_sent "$http_referer" '
          '"$http_user_agent" "$http_x_forwarded_for"';
        
          access_log  /var/log/nginx/access.log  main;
        
          sendfile        on;
          #tcp_nopush     on;
        
          keepalive_timeout  65;
        
          #gzip  on;
        
          include /etc/nginx/conf.d/*.conf;
        }

      stream.conf: |-
        server {
            listen 1883;
            proxy_pass emqx.infrastructure.svc.cluster.local:1883;
            proxy_connect_timeout 10s;
            proxy_timeout 1800s;
            proxy_buffer_size 3M;
            tcp_nodelay on;
        }

      http.conf: |-
        upstream minio_s3 {
          least_conn;
          server 192.168.1.45:9000;
        }
          
        upstream minio_console {
          least_conn;
          server 192.168.1.45:9001;
        }
          
        server {
          listen       80;
          listen  [::]:80;
          server_name  api.minio.homelab.io;
          
          ignore_invalid_headers off;
          client_max_body_size 0;
          proxy_buffering off;
          proxy_request_buffering off;
          
          location / {
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_connect_timeout 300;
            # Default is HTTP/1, keepalive is only enabled in HTTP/1.1
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            chunked_transfer_encoding off;
            
            proxy_pass http://minio_s3;
          }
        }
          
        server {
          listen       80;
          listen  [::]:80;
          server_name  console.minio.homelab.io;
          
          ignore_invalid_headers off;
          client_max_body_size 0;
          proxy_buffering off;
          proxy_request_buffering off;
          
          location / {
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-NginX-Proxy true;
            real_ip_header X-Real-IP;
            proxy_connect_timeout 300;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            chunked_transfer_encoding off;
            
            proxy_pass http://minio_console/;
          }
        }
        
        map $http_upgrade $connection_upgrade {
            default upgrade;
            ''      close;
        }
        
        server {
            listen 80;
            server_name auth.homelab.io;
            charset     utf-8;
            client_max_body_size 0;
        
            location /health {
                rewrite ^/health(.*)$ /health$1 break;
          
                proxy_pass http://keycloak.infrastructure.svc.cluster.local:9000;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto https;
            }

            location / {
                proxy_pass http://keycloak.infrastructure.svc.cluster.local:8080;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto https;
            }
        }

        server {
            listen 80;
            server_name events.homelab.io;
            charset     utf-8;
            client_max_body_size 0;

            include /etc/nginx/mime.types;
            default_type application/octet-stream;
            sendfile on;
            tcp_nopush on;
            tcp_nodelay on;
            gzip on;
            gzip_min_length 1000;
            gzip_proxied any;
            proxy_next_upstream error;

            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Scheme $scheme;
            proxy_set_header Host $http_host;

            location /connection {
                proxy_pass http://centrifugo.infrastructure.svc.cluster.local:8000;
                proxy_buffering off;
                keepalive_timeout 65;
                proxy_read_timeout 60s;
                proxy_http_version 1.1;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Scheme $scheme;
                proxy_set_header Host $http_host;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection $connection_upgrade;
            }

            location / {
                proxy_pass http://centrifugo.infrastructure.svc.cluster.local:9000;
            }

            error_page   500 502 503 504  /50x.html;

            location = /50x.html {
                root   /usr/share/nginx/html;
            }
        }
        
        server {
          listen 80;
          server_name mqtt.homelab.io;
          charset utf-8;
          client_max_body_size 0;

          location /mqtt {
              proxy_pass http://emqx.infrastructure.svc.cluster.local:8083;
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection $connection_upgrade;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header REMOTE-HOST $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
              proxy_buffering off;
              proxy_connect_timeout 10s;
              proxy_send_timeout 3600s;
              proxy_read_timeout 3600s;
          }
        
          location / {
              proxy_pass http://emqx.infrastructure.svc.cluster.local:18083/;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header REMOTE-HOST $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          }
        }
        
        server {
          listen 80;
          server_name registry.homelab.io;
          client_max_body_size 0;
          charset     utf-8;
        
        
          location / {
            proxy_pass http://harbor.registry.svc.cluster.local:80/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host               $host;
            proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto  https;
            proxy_set_header X-Real-IP          $remote_addr;
          }
        }

ingress:
  enabled: true
  class: nginx
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/proxy-body-size: "0"
    nginx.ingress.kubernetes.io/proxy-http-version: "1.1"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-request-buffering: "off"
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
  hosts:
    - host: auth.homelab.io
      serviceName: gateway-nginx
      servicePort: 80
    - host: api.minio.homelab.io
      serviceName: gateway-nginx
      servicePort: 80
    - host: console.minio.homelab.io
      serviceName: gateway-nginx
      servicePort: 80
  tls:
    - secretName: homelab-tls
      hosts:
        - auth.homelab.io
        - api.minio.homelab.io
        - console.minio.homelab.io

ingressList:
  - name: stream-ws
    class: nginx
    annotations:
      kubernetes.io/ingress.class: nginx
      nginx.ingress.kubernetes.io/proxy-body-size: "0"
      nginx.ingress.kubernetes.io/cors-allow-origin: "*"
      nginx.ingress.kubernetes.io/cors-allow-methods: "*"
      nginx.ingress.kubernetes.io/cors-allow-headers: "*"
      nginx.ingress.kubernetes.io/proxy-http-version: "1.1"
      nginx.ingress.kubernetes.io/proxy-connect-timeout: "3600"
      nginx.ingress.kubernetes.io/proxy-request-buffering: "off"
    hosts:
      - host: events.homelab.io
        serviceName: gateway-nginx
        servicePort: 80
        paths:
          - path: /
            pathType: ImplementationSpecific
      - host: mqtt.homelab.io
        serviceName: gateway-nginx
        servicePort: 80
        paths:
          - path: /
            pathType: ImplementationSpecific
      - host: registry.homelab.io
        serviceName: gateway-nginx
        servicePort: 80
        paths:
          - path: /
            pathType: ImplementationSpecific
    tls:
      - secretName: homelab-tls
        hosts:
          - events.homelab.io
          - mqtt.homelab.io
          - registry.homelab.io